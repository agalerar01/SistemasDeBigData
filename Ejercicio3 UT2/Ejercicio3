import requests
from bs4 import BeautifulSoup
import pandas as pd
import time

url_base = "https://coinmarketcap.com/?page={}"
headers = {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/121.0.0.0 Safari/537.36'
}

def limpiar_dato(texto):
    if not texto: return 0.0
    limpio = ''.join(c for c in texto if c.isdigit() or c in '.-')
    try:
        return float(limpio)
    except:
        return 0.0

todas_las_criptos = []

for i in range(1, 35): 
    try:
        res = requests.get(url_base.format(i), headers=headers, timeout=10)
        soup = BeautifulSoup(res.text, 'html.parser')
        
        filas = soup.find_all('tr')
        
        contador_en_pagina = 0
        for fila in filas:
            tds = fila.find_all('td')
            if len(tds) < 8: continue

            nombre_tag = fila.select_one('.coin-item-name') or fila.select_one('p[font-weight="semibold"]')
            simbolo_tag = fila.select_one('.coin-item-symbol') or fila.select_one('p[color="text3"]')
            
            if nombre_tag and simbolo_tag:
                nombre = nombre_tag.text.strip()
                simbolo = simbolo_tag.text.strip()
                precio = tds[3].text.strip()
                mkt_cap = tds[7].text.strip()
                volumen = tds[8].text.strip()

                todas_las_criptos.append({
                    'Nombre': nombre,
                    'Símbolo': simbolo,
                    'Precio': limpiar_dato(precio),
                    'Market Cap': limpiar_dato(mkt_cap),
                    'Volumen (24h)': limpiar_dato(volumen)
                })
                contador_en_pagina += 1
        
        if len(todas_las_criptos) >= 500:
            break
            
        time.sleep(2)

    except Exception as e:
        print(f"Error en página {i}: {e}")

df = pd.DataFrame(todas_las_criptos)
df = df.drop_duplicates(subset=['Nombre', 'Símbolo']).head(500)
df.to_csv('cripto_data.csv', index=False, encoding='utf-8-sig')

print(f"\n✅ ¡Misión cumplida! Se han guardado {len(df)} registros en 'cripto_data.csv'.")